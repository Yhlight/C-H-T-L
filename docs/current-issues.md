# CHTL 编译器当前架构问题分析

## 核心问题

### 1. 状态机设计问题
- **问题**：状态机没有真正的"状态"，只是用布尔标志跟踪上下文
- **影响**：
  - 无法区分顶层声明和内部引用
  - CSS 属性值解析错误（如 `#` 被误解析）
  - 模板/自定义组件无法正确展开
  - 上下文切换不够智能

### 2. 词法分析器问题
- **问题**：词法分析器和状态机耦合不清晰
- **影响**：
  - Token 类型识别依赖全局映射，不考虑上下文
  - 特殊字符（如 `#`）的含义无法根据上下文变化
  - 难以处理嵌套结构

### 3. 语法分析器问题
- **问题**：解析逻辑分散，缺乏统一的状态管理
- **影响**：
  - `parseTopLevel` 允许任意元素作为顶层节点
  - 模板定义和引用的区分依赖位置而非状态
  - 错误恢复机制不完善

### 4. 上下文系统问题
- **问题**：上下文信息传递不充分
- **影响**：
  - 变量作用域管理混乱
  - 模板参数传递不可靠
  - 嵌套结构的上下文丢失

### 5. 生成器问题
- **问题**：生成逻辑与 AST 结构耦合过紧
- **影响**：
  - 特殊节点（如 document）需要硬编码处理
  - 局部/全局样式判断依赖父节点类型
  - 模板展开逻辑复杂且易错

## 根本原因

**状态机没有发挥应有的作用**：
- 应该由状态机驱动整个编译过程
- 每个状态应该明确定义可接受的输入和转换规则
- 上下文应该与状态紧密结合

## 解决方案概述

需要完全重新设计编译器架构：

1. **状态机驱动的架构**
   - 明确的状态定义
   - 状态转换规则
   - 状态相关的 Token 识别

2. **上下文感知的词法分析**
   - Token 类型由当前状态决定
   - 特殊字符含义随状态变化

3. **递归下降的语法分析**
   - 每个状态有对应的解析方法
   - 清晰的错误恢复策略

4. **分层的上下文管理**
   - 作用域栈
   - 参数绑定
   - 符号表

5. **访问者模式的生成器**
   - 简化的 AST 遍历
   - 状态相关的代码生成