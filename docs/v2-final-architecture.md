# CHTL v2 最终架构

## 🏗️ 核心架构

### 四个独立编译器

```
┌─────────────────────────────────────────────────────────┐
│                    CHTL 主编译器                          │
│  - 词法分析器 (状态感知)                                  │
│  - 语法分析器 (递归下降)                                  │
│  - 代码生成器 (访问者模式)                                │
└─────────────────────────────────────────────────────────┘
                           │
        ┌─────────────────┼─────────────────┐
        ↓                 ↓                 ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ CSS 分析器    │  │ JS 分析器     │  │ CHTL-JS 编译器│
│              │  │              │  │              │
│ 只处理标准    │  │ 只处理标准    │  │ 处理 {{}}    │
│ CSS 语法     │  │ JavaScript   │  │ 扩展语法      │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 📋 功能清单

### ✅ 已实现

1. **状态机系统**
   - 主状态 + 子状态架构
   - 全局/局部上下文管理
   - 状态驱动的 Token 识别

2. **局部样式（已修正）**
   - 内联样式：直接写在 `style {}` 中
   - 自动添加类名：`.className {}`
   - 自动添加 ID：`#id {}`
   - `&` 选择器支持：`&:hover`

3. **模板系统**
   - 模板定义：`[Template] @Element Name(params)`
   - 模板引用：`@Element Name(args)`
   - 参数替换

4. **CHTL-JS 语法**
   - `{{#id}}` - 元素选择器
   - `{{&}}` - 当前元素
   - 运行时库生成

5. **导入系统**
   - 多种导入类型支持
   - 官方模块 `CHTL::` 前缀
   - 灵活的路径解析

### 🚧 待完成

1. **CMOD 系统**
   - 组件包管理
   - 依赖解析
   - 版本控制

2. **性能优化**
   - 并行编译
   - 增量编译
   - 缓存机制

## 🔍 关键代码示例

### 局部样式
```chtl
div {
    style {
        // 内联样式
        width: 100px;
        height: 200px;
        
        // 自动添加类名
        .box {
            background: white;
            border: 1px solid #ccc;
        }
        
        // 使用 & 简化
        &:hover {
            background: #f0f0f0;
        }
    }
}
```

生成：
```html
<div class="box" style="width: 100px; height: 200px;"></div>
```
```css
.box {
    background: white;
    border: 1px solid #ccc;
}
.box:hover {
    background: #f0f0f0;
}
```

### 导入系统
```chtl
// 导入官方组件
[Import] @Element "CHTL::UI::Button"

// 导入样式
[Import] @Style "./styles/theme.css"

// 导入 JavaScript
[Import] @JavaScript "./utils/helpers.js"

// 导入 CHTL 文件
[Import] @Chtl "./components/header"
```

## 📁 项目结构

```
/workspace/
├── include/v2/
│   ├── State/           # 状态机系统
│   ├── Lexer/           # 词法分析
│   ├── Parser/          # 语法分析  
│   ├── Node/            # AST 节点
│   ├── Context/         # 上下文管理
│   ├── Generator/       # 代码生成
│   ├── Css/             # CSS 分析器
│   ├── Js/              # JS 分析器
│   ├── ChtlJs/          # CHTL-JS 编译器
│   └── Import/          # 导入系统
└── src/v2/              # 实现文件
```

## 🎯 设计原则

1. **独立性**：四个编译器完全独立，各司其职
2. **状态驱动**：状态决定一切解析行为
3. **全局定义，局部引用**：统一的语义规则
4. **简化处理**：CSS/JS 整块传递，不做细粒度解析

## 📈 性能考虑

- CSS/JS 分析可并行执行
- 模板定义预先收集，避免多次遍历
- 局部样式批量处理，减少 DOM 操作

## 🔧 扩展点

1. **新的导入类型**：在 `ImportType` 枚举添加
2. **新的节点类型**：继承 `Node` 基类
3. **新的状态**：在 `ChtlParseState` 添加
4. **新的 CHTL-JS 语法**：扩展 `ChtlJsCompiler`

## 总结

CHTL v2 通过状态机驱动的架构和四个独立编译器的设计，实现了清晰的关注点分离。每个组件都有明确的职责，易于维护和扩展。局部样式的正确实现使得样式管理更加灵活，导入系统的加入为模块化开发提供了基础。