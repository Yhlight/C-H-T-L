# CHTL模块自动打包系统文档

## 概述

CHTL构建系统现在支持自动扫描、打包和部署CMOD（CHTL模块）和CJMOD（CHTL JavaScript模块）。这个功能集成在CMake构建流程中，为IDE和工具链提供了标准化的模块管理方案。

## 功能特性

### 1. 自动模块扫描
- 构建时自动扫描`module/`目录
- 识别符合CMOD/CJMOD标准格式的模块
- 验证模块结构完整性

### 2. 模块打包
- **CMOD**: 打包为`.cmod`文件（tar.gz格式或文本格式）
- **CJMOD**: 编译为共享库（`.cjmod`文件）
- 保留目录结构和元数据

### 3. 模块部署
- 打包后的模块自动复制到`build/module/`目录
- 生成`modules.index`索引文件
- 支持安装到系统目录

## 模块格式要求

### CMOD（CHTL模块）
```
ModuleName/
├── src/
│   └── *.chtl        # CHTL源文件
└── info/
    └── ModuleName.chtl  # 模块信息文件（必须包含[Info]块）
```

### CJMOD（CHTL JavaScript模块）
```
ModuleName/
├── src/
│   ├── *.cpp         # C++源文件
│   └── *.h           # 头文件
└── info/
    └── ModuleName.chtl  # 模块信息文件
```

## 使用方法

### 1. 基本构建
```bash
mkdir build
cd build
cmake ..
make
```

### 2. 手动触发模块打包
```bash
make pack-modules
```

### 3. 完整构建（包括解析器生成和模块打包）
```bash
make build-all
```

### 4. 安装到系统
```bash
sudo make install
```

模块将被安装到：`/usr/local/share/chtl/module/`

## CMake集成

### 在CMakeLists.txt中使用
```cmake
# 包含模块功能
include(CHTLModules)

# 自动处理模块
process_chtl_modules()

# 或指定自定义路径
process_chtl_modules(
    SOURCE_DIR "${CMAKE_SOURCE_DIR}/my_modules"
    OUTPUT_DIR "${CMAKE_BINARY_DIR}/output"
)
```

### 添加自定义模块打包目标
```cmake
add_module_packing_target()
```

## 模块索引文件

构建后会生成`modules.index`文件，格式如下：
```
# CHTL Module Index
# Generated by CMake

CMOD_COUNT=1
CJMOD_COUNT=0

[CMOD]
Chtholly

[CJMOD]
```

## 高级配置

### 自定义打包行为

修改`cmake/CHTLModules.cmake`中的函数：

- `is_valid_cmod()` - 自定义CMOD验证逻辑
- `is_valid_cjmod()` - 自定义CJMOD验证逻辑
- `pack_cmod()` - 自定义CMOD打包方式
- `pack_cjmod()` - 自定义CJMOD编译选项

### 环境变量
- `CHTL_MODULE_PATH` - 额外的模块搜索路径
- `CHTL_NO_PACK` - 禁用自动模块打包

## 示例：Chtholly模块

项目中包含了一个完整的CMOD示例 - Chtholly模块：

```
module/Chtholly/
├── src/
│   └── Chtholly.chtl     # 主题样式和组件
├── info/
│   └── Chtholly.chtl     # 模块信息和导出表
├── example.chtl          # 使用示例
└── README.md             # 模块文档
```

构建后生成：
- `build/module/Chtholly.cmod` - 打包的模块文件
- `build/module/modules.index` - 模块索引

## IDE集成建议

### 1. 模块发现
- 读取`modules.index`获取可用模块列表
- 扫描`.cmod`和`.cjmod`文件

### 2. 模块导入
- 支持从模块目录导入
- 解析模块的`[Export]`块获取可用组件

### 3. 智能提示
- 基于模块导出表提供代码补全
- 显示模块文档和示例

### 4. 模块管理
- 提供模块浏览器UI
- 支持模块的安装/卸载
- 模块依赖管理

## 故障排除

### 模块未被识别
- 检查目录结构是否符合标准
- 确保`info/ModuleName.chtl`存在且包含`[Info]`块
- 查看CMake输出中的警告信息

### 打包失败
- 确保`tar`命令可用（用于CMOD打包）
- 检查文件权限
- 查看CMake错误日志

### CJMOD编译失败
- 确保安装了C++17兼容的编译器
- 检查源代码是否有语法错误
- 确认必要的头文件路径

## 最佳实践

1. **模块命名**：使用清晰、描述性的名称
2. **版本管理**：在`[Info]`块中包含版本信息
3. **文档**：每个模块都应包含README.md
4. **示例**：提供example.chtl展示用法
5. **导出控制**：使用`[Export]`块明确公开的API

## 未来计划

- 支持模块依赖自动解析
- 实现模块包管理器（类似npm）
- 支持远程模块仓库
- 添加模块签名验证
- 优化大型模块的打包性能