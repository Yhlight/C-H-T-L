// CJmod å®Œæ•´ç¤ºä¾‹ - å±•ç¤º CHTL JS çš„æ— é™å¯èƒ½

// å¯¼å…¥å“åº”å¼ç¼–ç¨‹æ¨¡å—
[Import] @CJmod reactive from "builtin:reactive";

// å¯¼å…¥äº‹ä»¶å§”æ‰˜æ¨¡å—
[Import] @CJmod delegate from "builtin:delegate";

// å¯¼å…¥æ—¶é—´æ—…è¡Œè°ƒè¯•å™¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
[Import] @CJmod timetravel from "builtin:timetravel" if { env: "development" };

// ä¸»åº”ç”¨
[Custom] @Element TodoApp {
    div {
        class: "todo-app";
        
        // å±€éƒ¨æ ·å¼
        style {
            .todo-app {
                max-width: 600px;
                margin: 0 auto;
                padding: 20px;
            }
            
            .todo-list {
                list-style: none;
                padding: 0;
            }
            
            .todo-item {
                display: flex;
                align-items: center;
                padding: 10px;
                border: 1px solid #ddd;
                margin: 5px 0;
            }
            
            &:hover {
                background: #f5f5f5;
            }
        }
        
        h1 { text { "å¾…åŠäº‹é¡¹ - CJmod æ¼”ç¤º" } }
        
        div {
            class: "input-group";
            
            input {
                id: "todo-input";
                type: "text";
                placeholder: "æ·»åŠ æ–°ä»»åŠ¡...";
                
                script {
                    // ä½¿ç”¨å“åº”å¼è¯­æ³•
                    todoText := "";
                    
                    // åŒå‘ç»‘å®š
                    {{&}}->bind("todoText");
                    
                    // Enter é”®æ·»åŠ ä»»åŠ¡
                    {{&}}->listen("keypress", (e) => {
                        if (e.key === "Enter" && todoText.value.trim()) {
                            addTodo(todoText.value);
                            todoText.value = "";
                        }
                    });
                }
            }
            
            button {
                text { "æ·»åŠ " }
                
                script {
                    {{&}}->listen("click", () => {
                        if (todoText.value.trim()) {
                            addTodo(todoText.value);
                            todoText.value = "";
                        }
                    });
                }
            }
        }
        
        // ç»Ÿè®¡ä¿¡æ¯
        div {
            class: "stats";
            
            script {
                // è®¡ç®—å±æ€§
                totalCount => todos.value.length;
                completedCount => todos.value.filter(t => t.completed).length;
                activeCount => totalCount.value - completedCount.value;
                
                // ç›‘å¬å˜åŒ–æ›´æ–° UI
                watch todos -> {
                    {{&}}.innerHTML = `
                        æ€»è®¡: ${totalCount.value} | 
                        å®Œæˆ: ${completedCount.value} | 
                        å¾…åŠ: ${activeCount.value}
                    `;
                };
            }
        }
        
        // ä»»åŠ¡åˆ—è¡¨
        ul {
            class: "todo-list";
            
            script {
                // å“åº”å¼ä»»åŠ¡æ•°ç»„
                todos := [
                    { id: 1, text: "å­¦ä¹  CHTL", completed: false },
                    { id: 2, text: "ä½¿ç”¨ CJmod", completed: false }
                ];
                
                // æ·»åŠ ä»»åŠ¡å‡½æ•°
                function addTodo(text) {
                    record {  // æ—¶é—´æ—…è¡Œè®°å½•ç‚¹
                        todos.value = [...todos.value, {
                            id: Date.now(),
                            text: text,
                            completed: false
                        }];
                    }
                }
                
                // äº‹ä»¶å§”æ‰˜ - å¤„ç†æ‰€æœ‰å­å…ƒç´ çš„äº‹ä»¶
                on .todo-checkbox change -> {
                    const todoId = parseInt(e.target.dataset.todoId);
                    record {
                        todos.value = todos.value.map(todo => 
                            todo.id === todoId 
                                ? { ...todo, completed: e.target.checked }
                                : todo
                        );
                    }
                };
                
                on .delete-btn click -> {
                    const todoId = parseInt(e.target.dataset.todoId);
                    assert todos.value.length > 0 : "ä»»åŠ¡åˆ—è¡¨ä¸åº”ä¸ºç©º";
                    
                    record {
                        todos.value = todos.value.filter(todo => todo.id !== todoId);
                    }
                };
                
                // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                function renderTodos() {
                    {{&}}.innerHTML = todos.value.map(todo => `
                        <li class="todo-item">
                            <input 
                                type="checkbox" 
                                class="todo-checkbox"
                                data-todo-id="${todo.id}"
                                ${todo.completed ? 'checked' : ''}
                            />
                            <span style="${todo.completed ? 'text-decoration: line-through' : ''}">
                                ${todo.text}
                            </span>
                            <button class="delete-btn" data-todo-id="${todo.id}">åˆ é™¤</button>
                        </li>
                    `).join('');
                }
                
                // ç›‘å¬ todos å˜åŒ–
                watch todos -> {
                    measure "render todos" {
                        renderTodos();
                    }
                };
                
                // åˆå§‹æ¸²æŸ“
                renderTodos();
            }
        }
        
        // è°ƒè¯•å·¥å…·æ ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
        div {
            class: "debug-toolbar";
            if { env: "development" }
            
            button {
                text { "âª æ’¤é”€" }
                script {
                    {{&}}->listen("click", () => {
                        jump -1;
                    });
                }
            }
            
            button {
                text { "â© é‡åš" }
                script {
                    {{&}}->listen("click", () => {
                        jump +1;
                    });
                }
            }
            
            button {
                text { "ğŸ“¸ å¿«ç…§" }
                script {
                    {{&}}->listen("click", () => {
                        snapshot "manual-checkpoint";
                    });
                }
            }
            
            button {
                text { "ğŸ“Š æ€§èƒ½" }
                script {
                    {{&}}->listen("click", () => {
                        monitor events;
                    });
                }
            }
        }
    }
}

// é¡µé¢ç»“æ„
html {
    head {
        title { text { "CJmod æ¼”ç¤º - CHTL JS çš„æ— é™å¯èƒ½" } }
        meta { charset: "UTF-8"; }
    }
    
    body {
        style {
            font-family: "Arial, sans-serif";
            margin: 0;
            padding: 0;
            background: #f0f0f0;
        }
        
        // ä½¿ç”¨ TodoApp ç»„ä»¶
        @Element TodoApp;
        
        // å…¨å±€è„šæœ¬
        script {
            // åˆå§‹åŒ–æ¶ˆæ¯
            console.log("CHTL JS with CJmod - The Future of Web Development!");
            
            // æ€§èƒ½ç›‘æ§
            measure "app startup" {
                console.log("åº”ç”¨å¯åŠ¨å®Œæˆ");
            }
        }
    }
}